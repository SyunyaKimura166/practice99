# 3. AIエージェントについて<!-- omit in toc -->

この章ではAIエージェントの設計・構成・インフラについてまとめる。

### 注意点<!-- omit in toc -->
**AIエージェントは2025年12月初旬にAgentCoreを使用する方針に変更となった。現在はAIエージェントの実装方針は検討中であり、以下の内容や（TBD）箇所は今後変更となる可能性がある。**  
**ただし、今後の検討でAgentCoreが使用できないAIエージェント呼び出しが発生した場合は、既存案を採用する可能性がある。**  
**本資料にはAgentCoreを使用しない場合のAIエージェント設計方針を記載しているが、将来的には内容が大幅に変更される可能性があることに注意のこと。**  
AgentCoreについては以下のGitHubリポジトリを参照のこと:  
https://github.com/IoVPF-AgenticSoftwareEngineering/dora2

### 目次<!-- omit in toc -->
- [3.1. AIエージェントの概要](#31-aiエージェントの概要)
  - [3.1.1 AIエージェント分割の方針](#311-aiエージェント分割の方針)
- [3.2. 現状分析](#32-現状分析)
  - [3.2.1 現行のエージェント構成](#321-現行のエージェント構成)
- [3.3. 分解の基本方針](#33-分解の基本方針)
  - [3.3.1 Git中心のアーティファクト管理](#331-git中心のアーティファクト管理)
  - [3.3.2 MCPによる疎結合通信](#332-mcpによる疎結合通信)
  - [3.3.3 人のゲート統合](#333-人のゲート統合)
  - [3.3.4 分解後のエージェント構成](#334-分解後のエージェント構成)
- [3.4. 各エージェントの詳細仕様](#34-各エージェントの詳細仕様)
  - [3.4.1 Director Agent](#341-director-agent)
  - [3.4.2 DevPlanner Agent](#342-devplanner-agent)
  - [3.4.3 Requirements Analyst Agent](#343-requirements-analyst-agent)
  - [3.4.4 Design Agent](#344-design-agent)
  - [3.4.5 Coding Agent](#345-coding-agent)
  - [3.4.6 Debug Agent](#346-debug-agent)
  - [3.4.7 Test Agent](#347-test-agent)
  - [3.4.8 Review Agent](#348-review-agent)
  - [3.4.9 Documentation Agent](#349-documentation-agent)
  - [3.4.10 Integration Agent](#3410-integration-agent)
- [3.5. 通信アーキテクチャ](#35-通信アーキテクチャ)
  - [3.5.1 MCP通信の詳細](#351-mcp通信の詳細)
  - [3.5.2 ワークフローオーケストレーション](#352-ワークフローオーケストレーション)
- [3.6. デプロイメントアーキテクチャ](#36-デプロイメントアーキテクチャ)
---

## 3.1. AIエージェントの概要

DevPlannerから起動されるAIエージェントは、既存のsoftware_developer_agent（6エージェント構成）を分割・拡張して作成する。各エージェントは独立したEC2インスタンスで運用され、MCP（Model Context Protocol）を介して連携する。

### 3.1.1 AIエージェント分割の方針

本ドキュメントでは、software_developer_agentを以下の観点で分解する:

- **分解方針**: 1エージェント1機能1EC2インスタンスのマイクロサービス化
- **通信方式**: 全てのエージェント間通信をMCP（Model Context Protocol）経由で実施
- **成果物管理**: Git中心のアーティファクト管理を継続
- **オーケストレーション**: GitHub Actions、Apache Airflow、AWS StepFunctionsのマルチオーケストレーション
- **人のゲート**: 設計レビュー、PRレビューなど重要なポイントでの人の関与

### 3.1.2 分解の主要な理由<!-- omit in toc -->

1. **役割の明確化**: 各エージェントを専門特化させ、責務を明確にする
2. **スケーラビリティ**: 需要に応じて特定エージェント（特にCoding Agent）を水平スケール
3. **障害の影響範囲限定**: 1エージェントの障害が全体に波及しない
4. **並行開発**: チームメンバーが異なるエージェントを並行開発可能

### 3.1.3 分解後の構成<!-- omit in toc -->

- **エージェント数**: 6エージェント → 10-12エージェント
- **デプロイ単位**: モノリシック → マイクロサービス（各エージェント1 EC2インスタンス）
- **通信**: 直接呼び出し → MCP経由の疎結合通信
- **オーケストレーション**: 単一オーケストレーター → GitHub Actions + Airflow + StepFunctions

---

## 3.2. 現状分析

### 3.2.1 現行のエージェント構成

現行のsoftware_developer_agentは以下の6エージェントで構成される。

| エージェント名 | 主要機能 | 入力 | 出力 |
|--------------|---------|------|------|
| **Requirements Analyst** | 要件分析 | ユーザー要求 | 要件定義書 (requirements/*.md) |
| **System Architect** | システム設計 | 要件定義書 | 設計書 (design/*.md) |
| **Software Coder** | コード実装 | 設計書 | ソースコード (src/**/*) |
| **Test Developer** | テスト作成・実行 | ソースコード | テストコード (tests/**/*), テスト結果 |
| **Code Reviewer** | コードレビュー | PR | レビューコメント |
| **Documentation Writer** | ドキュメント作成 | コード・設計書 | ドキュメント (docs/**/*) |

#### 現行エージェントの強み<!-- omit in toc -->

- ✅ 専門エージェントによる高精度な処理
- ✅ 品質改善ループ（最大3回反復）による継続的改善
- ✅ ProcessResultによる一貫したコンテキスト管理
- ✅ 多言語対応（C++, Python, Rust, TypeScript, Shell, HTML, CSS）
- ✅ 言語固有最適化（コーディング規約、テストフレームワーク）

#### 現行エージェントの課題<!-- omit in toc -->

- ⚠️ **精度面**: 複雑な要件、大規模プロジェクトへの対応が限定的
- ⚠️ **再現性**: AIの非決定性、品質評価の主観性
- ⚠️ **保守性**: システムテストの不在、モニタリング不足
- ⚠️ **スケーラビリティ**: 並行処理非対応、単一オーケストレーター
- ⚠️ **デプロイ**: モノリシックな構成、部分的な更新が困難

---

## 3.3. 分解の基本方針

### 3.3.1 Git中心のアーティファクト管理

すべてのエージェント成果物はGitで管理する。

- **成果物**: ソースコード、設計書、テスト、ドキュメント
- **履歴管理**: コミット履歴で完全なトレーサビリティ
- **協調**: Pull Requestベースのレビューフロー
- **ロールバック**: Git revertで簡単に巻き戻し

### 3.3.2 MCPによる疎結合通信

全エージェント間通信はMCP経由で実施する。

- **Agent ← → Agent**: MCP Messaging Server経由
- **Agent ← → Git**: Git MCP Server経由
- **Agent ← → 外部システム**: 専用MCPサーバー（Digital Twin, CI/CD, ML）経由
- **Agent ← → LLM**: 各エージェントが直接APIコール

**メリット**:
- ✅ 疎結合: エージェント間の依存関係を最小化
- ✅ プラグイン性: 新しいエージェントやMCPサーバーの追加が容易
- ✅ テスト容易性: MCPサーバーをモック化してユニットテスト可能

### 3.3.3 人のゲート統合

重要なポイントで人のレビューを必須化する。

- **設計ゲート**: Design Agentの成果物レビュー（Issue Comment）
- **レビューゲート**: PRレビュー（人またはReview Agent）
- **承認ゲート**: PRマージ承認（人のみ）

### 3.3.4 分解後のエージェント構成

分解後は以下の10-12エージェントで構成する。

| # | エージェント名 | 責務 | デプロイ |
|---|--------------|------|---------|
| **1** | **Director Agent**  | 開発計画立案、全体統括 | EC2インスタンス0台（GitHub Actions） |
| **2** | **DevPlanner Agent** | タスク分解、エージェント割り当て | EC2インスタンス0台（GitHub Actions） |
| **3** | **Requirements Analyst Agent** | 要件定義書作成 | EC2インスタンス1台 |
| **4** | **Design Agent** | システム設計、アーキテクチャ設計 | EC2インスタンス1台 |
| **5** | **Coding Agent** | コード実装 | EC2インスタンス2-5台（需要に応じてスケール） |
| **6** | **Debug Agent** | バグ修正、デバッグ | EC2インスタンス1台 |
| **7** | **Test Agent**  | テスト自動化、実行 | EC2インスタンス1台 |
| **8** | **Review Agent** | コードレビュー、品質チェック | EC2インスタンス1台 |
| **9** | **Documentation Agent** | ドキュメント作成、更新 | EC2インスタンス1台 |
| **10** | **Integration Agent** | デプロイ管理、統合テスト | EC2インスタンス1台 |

### 3.3.5 エージェント間の依存関係<!-- omit in toc -->

```
Director Agent
    ↓ (GitHub Issue)
DevPlanner Agent（タスク分割後に各種エージェントを起動）
    ↓ (MCP)
    ├→ Requirements Analyst Agent
    ├→ Design Agent
    ├→ Coding Agent (複数インスタンス並行動作)
    ├→ Test Agent
    ├→ Review Agent
    ├→ Documentation Agent
    └→ Integration Agent

DevPlanner Agent（Test Agentの結果によって起動）
    ↓ (MCP)
    └→ Debug Agent
```

## 3.4. 各エージェントの詳細仕様

### 3.4.1 Director Agent

  - **役割**:
    - プロジェクト全体の開発計画立案
    - マイルストーン管理
    - リソース割り当て（どのエージェントをいつ起動するか）

  - **入力**:
    - GitHub Issue（`Status=Backlog`）

  - **出力**:
    - DevPlanner Agentへのタスク指示
    - GitHub IssueのStatusを変更する（`Status=作業前`）

  - **ワークフロー**:
    - GitHub IssueのStatusを監視し、`Backlog`から`作業前`に変更

  - **MCPツール利用**:
    - `git_mcp`: GitHub Issueの更新

  - **デプロイ**:
    - GitHub Actions: Issue作成イベントで起動
  
### 3.4.2 DevPlanner Agent

  - **役割**:
    - Director Agentからの計画を受け取り、Claudeを使ってタスク分解
    - 各専門エージェントへのタスク割り当て

  - **入力**:
    - GitHub Issue（`Status=作業前`）

  - **出力**:
    - 各エージェントへのタスク指示（MCP Message）

  - **ワークフロー**:
    - GitHub IssueのStatusを監視し、`作業前`から`作業中`に変更
    - GitHub Issueのタスクを分解し、各エージェントにMCPメッセージで指示を送信

  - **MCPツール利用**:
    - `git_mcp`: タスクドキュメントのコミット、Issue Commentの投稿
    - `agent_messaging_mcp`: 他エージェントへのメッセージ送信/受信

  - **デプロイ**:
    - GitHub Actions: Issue作成イベントで起動

### 3.4.3 Requirements Analyst Agent

  - **役割**:
    - DevPlannerから要件定義書作成
    - 機能要件・非機能要件の整理
    - 受け入れ基準の定義

  - **入力**:
    - DevPlannerからのタスク依頼（TASK_ASSIGNMENT）

  - **出力**:
    - 要件定義書（requirements/*.md）

  - **ワークフロー**:
    1. 要件定義書を作成し、Gitにコミットする
    2. ブランチを作成し、コミット・プッシュする
    3. 必要に応じてPRを作成する

  - **MCPツール利用**:
    - `git_mcp`: 要件定義書のコミット
    - `LLM MCP`: LLM呼び出し

  - **デプロイ**:
    - AWS EC2インスタンス1台
    - オンデマンド起動（DevPlanner Agentからの指示）

### 3.4.4 Design Agent

  - **役割**:
    - アーキテクチャ設計
    - 詳細設計（API設計、データモデル設計）
    - 設計書作成

  - **入力**:
    - DevPlannerからのタスク依頼（TASK_ASSIGNMENT）
    - Requirements Analyst Agentの要件定義書（requirements/*.md）
    - 既存の設計書・コード（Git）

  - **出力**:
    - 設計書（design/*.md）

  - **ワークフロー**:
    1. 設計書を作成し、Gitにコミットする
    2. ブランチを作成し、コミット・プッシュする
    3. 必要に応じてPRを作成する

  - **MCPツール利用**:
    - `git_mcp`: 設計書のコミット、branch作成
    - `LLM MCP`: LLM呼び出し

  - **デプロイ**:
    - AWS EC2インスタンス1台
    - オンデマンド起動（DevPlanner Agentからの指示）

### 3.4.5 Coding Agent

  - **役割**:
    - 設計書からソースコード生成
    - 単体テスト作成
    - コミット・プッシュ

  - **入力**:
    - DevPlannerからのタスク依頼（TASK_ASSIGNMENT）
    - Design Agentの設計書（design/*.md）
    - 既存のソースコード（Git）

  - **出力**:
    - ソースコード（src/**/*）
    - 単体テスト（tests/unit/**/*）

  - **ワークフロー**:
    1. 設計書を取得し、ソースコードを生成する
    2. 単体テストを作成する
    3. ブランチを作成し、コミット・プッシュする
    4. 必要に応じてPRを作成する

  - **MCPツール利用**:
    - `git_mcp`: ブランチ作成、コード書き込み、コミット、プッシュ
    - `LLM MCP`: LLM呼び出し

  - **スケーリング**:
    - **通常時**: EC2インスタンス2台
    - **ピーク時**: EC2インスタンス5台まで自動スケール（Auto Scaling Group）
    - **並行処理**: 複数タスクを異なるインスタンスで並行実行

  - **デプロイ**:
    - AWS Auto Scaling Group (EC2)
    - Min: 2台、Max: 5台
    - オンデマンド起動（DevPlanner Agentからの指示）

### 3.4.6 Debug Agent

  - **役割**:
    - バグ修正
    - パフォーマンス改善
    - Digital Twinでのテスト

  - **入力**:
    - DevPlannerからのタスク依頼（TASK_ASSIGNMENT）
    - Test Agentのテスト結果（MCP Message）
    - Review Agentのレビューコメント（MCP Message）
    - 既存のコード（Git）

  - **出力**:
    - 修正コード（src/**/*）
    - 修正内容のコミット
    - Director Agentへの報告（MCP Message）

  - **ワークフロー**:
    1. テスト結果とレビューコメントを受領する
    2. 問題箇所を修正する
    3. Digital Twinでシミュレーションテストを実行する
    4. 修正内容をコミットし、報告する

  - **MCPツール利用**:
    - `git_mcp`: コード読み取り、修正コミット
    - `LLM MCP`: LLM呼び出し

  - **デプロイ**:
    - AWS EC2インスタンス1台
    - オンデマンド起動（DevPlanner Agentからの指示）

### 3.4.7 Test Agent

  - **役割**:
    - 単体テスト実行
    - テスト結果の分析
    - カバレッジレポート作成

  - **入力**:
    - DevPlannerからのタスク依頼（TASK_ASSIGNMENT）
    - テストコード（tests/unit/**/*）

  - **出力**:
    - テスト結果レポート（tests/reports/*.md）
    - カバレッジレポート（tests/reports/*.md）

  - **ワークフロー**:
    1. テストを実行し、結果を取得する
    2. テスト結果レポートとカバレッジレポートを作成する

  - **MCPツール利用**:
    - `git_mcp`: テストコード取得
    - `LLM MCP`: LLM呼び出し

  - **デプロイ**:
    - AWS EC2インスタンス1台
    - オンデマンド起動（DevPlanner Agentからの指示）

### 3.4.8 Review Agent

  - **役割**:
    - コードレビュー
    - 品質チェック（コーディング規約、セキュリティ）
    - レビューコメント作成

  - **入力**:
    - DevPlannerからのタスク依頼（TASK_ASSIGNMENT）
    - Pull Request（GitHub API）
    - コードdiff（Git）

  - **出力**:
    - レビューコメント（GitHub PR Comment）

  - **ワークフロー**:
    1. コードレビューを実施する
    2. 自動レビュー結果をPR Commentに投稿する

  - **MCPツール利用**:
    - `git_mcp`: コードdiff取得
    - `LLM MCP`: LLM呼び出し

  - **デプロイ**:
    - AWS EC2インスタンス1台
    - オンデマンド起動（DevPlanner Agentからの指示）

### 3.4.9 Documentation Agent

  - **役割**:
    - APIドキュメント生成
    - ユーザーマニュアル作成
    - README更新

  - **入力**:
    - DevPlannerからのタスク依頼（TASK_ASSIGNMENT）
    - ソースコード（src/**/*）
    - 設計書（design/*.md）

  - **出力**:
    - APIドキュメント（docs/api/**/*）
    - ユーザーマニュアル（docs/manual/**/*）
    - README.md更新

  - **ワークフロー**:
    1. ソースコードと設計書を参照し、ドキュメントを生成する
    2. 生成したドキュメントをGitにコミットする
    3. 必要に応じてREADMEを更新する

  - **MCPツール利用**:
    - `git_mcp`: コード読み取り、ドキュメントコミット
    - `LLM MCP`: LLM呼び出し

  - **デプロイ**:
    - AWS EC2インスタンス1台
    - オンデマンド起動（DevPlanner Agentからの指示）

### 3.4.10 Integration Agent

  - **役割**:
    - 統合テスト実行
    - デプロイメント管理
    - ロールバック実施

  - **入力**:
    - DevPlannerからのタスク依頼（TASK_ASSIGNMENT）

  - **出力**:
    - デプロイ結果レポート（deploy/reports/*.md）

  - **ワークフロー**:
    1. ビルドおよびデプロイを実行する
    2. 統合テストを実行する
    3. 結果をレポートし、完了報告を送信する

  - **MCPツール利用**:
    - `git_mcp`: デプロイ用ファイル取得
    - `LLM MCP`: LLM呼び出し

  - **デプロイ**:
    - AWS EC2インスタンス1台
    - オンデマンド起動（DevPlanner Agentからの指示）

---

## 3.5. 通信アーキテクチャ

### 3.5.1 MCP通信の詳細

#### 3.5.1.1 MCPサーバー一覧<!-- omit in toc -->
| MCPサーバー | 提供機能 |
|------------|---------|
| **Git MCP** | Git操作（clone, commit, push, PR作成など） |
| **Agent Messaging MCP** | エージェント間メッセージング |
| **LLM MCP** | LLM呼び出し |

### 3.5.2 ワークフローオーケストレーション

#### 3.5.2.1 GitHub Actions<!-- omit in toc -->
**適用シーン**:
- Issue更新イベント → DevPlanner/Director Agent起動
- PR作成イベント → 各種AIエージェント起動
- Pushイベント → 各種AIエージェント起動

**設定例** 

```yaml
# .github/workflows/agent-task-handler.yml
name: Agent Task Handler
on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

jobs:
  dispatch-devplanner:
    if: contains(github.event.issue.body, '@agent-devplanner')
    runs-on: ubuntu-latest
    steps:
      - name: Trigger DevPlanner Agent
        run: |
          aws lambda invoke \
            --function-name devplanner-agent \
            --payload '{"issue_number": "${{ github.event.issue.number }}"}'
```

---

## 3.6. デプロイメントアーキテクチャ

### 3.6.1 AWS環境構成<!-- omit in toc -->

#### 3.6.1.1 エージェントデプロイ<!-- omit in toc -->
| エージェント | インスタンス数 | インスタンスタイプ | スケーリング |
|------------|--------------|------------------|-------------|
| DevPlanner | 0台 | - | - |
| Director | 0台 | - | - |
| Requirements Analyst | 1台 | t3.medium | 固定 |
| Design | 1台 | t3.medium | 固定 |
| **Coding** | **2-5台** | **c5.large** | **Auto Scaling** |
| Debug | 1台 | t3.medium | 固定 |
| Test | 1台 | c5.large | 固定 |
| Review | 1台 | t3.medium | 固定 |
| Documentation | 1台 | t3.small | 固定 |
| Integration | 1台 | t3.medium | 固定 |
| **合計** | **12-15台** | - | - |

**注記**:
- DevPlanner/DirectorはGitHub Actionsで起動するためインスタンス不要
- Coding Agentのみ Auto Scaling Group で水平スケール（需要に応じて2-5台）
- その他は固定1台（コスト最適化）

#### 3.6.1.2 MCPサーバーデプロイ<!-- omit in toc -->

- 各AIエージェント毎に必要なMCPサーバーを用意する。
- それぞれのEC2インスタンスにそれぞれのAIエージェントと必要なMCPサーバーを同居させる形でデプロイする。


***

[目次](./01_はじめに.md#目次)
