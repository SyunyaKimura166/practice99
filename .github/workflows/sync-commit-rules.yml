# Commitメッセージルール同期ワークフロー
# 同期元: IoVPF-AgenticSoftwareEngineering/ssh-ops-agent (research/ToDo_AI_tracking_check)
# 同期先: commit_message_rules/

name: Sync Commit Message Rules

on:
  schedule:
    - cron: '0 0 * * 1'  # 毎週月曜日 00:00 UTC
  workflow_dispatch:
    inputs:
      force:
        description: '強制同期（変更がなくてもPR作成）'
        required: false
        default: 'false'
        type: boolean

env:
  SOURCE_REPO: IoVPF-AgenticSoftwareEngineering/ssh-ops-agent
  SOURCE_BRANCH: research/ToDo_AI_tracking_check
  SOURCE_FILE: docs/guide/ai-usage-tracking-guide-for-beginners.md
  TARGET_DIR: commit_message_rules
  SYNC_BRANCH: sync/commit-rules-update

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      - name: Fetch latest from source
        run: |
          echo "=== 同期元: ${{ env.SOURCE_REPO }} (${{ env.SOURCE_BRANCH }}) ==="
          echo "=== 同期先: ${{ env.TARGET_DIR }}/ ==="

          # 同期元をclone（特定ブランチ）
          git clone --depth=1 --branch ${{ env.SOURCE_BRANCH }} \
            https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/${{ env.SOURCE_REPO }}.git \
            tmp-source

          # 既存ディレクトリを作成（なければ）
          mkdir -p "${{ env.TARGET_DIR }}"

          # 対象ファイルをコピー
          if [ -f "tmp-source/${{ env.SOURCE_FILE }}" ]; then
            cp "tmp-source/${{ env.SOURCE_FILE }}" "${{ env.TARGET_DIR }}/"
          else
            echo "警告: ソースファイルが見つかりません: ${{ env.SOURCE_FILE }}"
            exit 1
          fi

          # 不要ファイルを削除
          rm -rf tmp-source

          echo "=== 取得完了 ==="
          ls -la "${{ env.TARGET_DIR }}/"

      - name: Check for changes
        id: changes
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "変更なし"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "=== 変更内容 ==="
            git diff --cached --stat
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.changed == 'true' || github.event.inputs.force == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.PAT_TOKEN }}
          commit-message: "chore: Sync ${{ env.TARGET_DIR }} from ${{ env.SOURCE_REPO }}"
          branch: ${{ env.SYNC_BRANCH }}
          delete-branch: true
          title: '[自動同期] Commitメッセージルール最新化'
          body: |
            ## 概要
            Commitメッセージルールの同期元リポジトリから最新ファイルを同期しました。

            ## 詳細
            - **同期元リポジトリ**: `${{ env.SOURCE_REPO }}`
            - **同期元ブランチ**: `${{ env.SOURCE_BRANCH }}`
            - **同期元ファイル**: `${{ env.SOURCE_FILE }}`
            - **同期先ディレクトリ**: `${{ env.TARGET_DIR }}/`
            - **実行ID**: ${{ github.run_id }}

            ## 確認事項
            - [ ] 変更内容を確認
            - [ ] 動作確認（必要に応じて）

            ---
            このPRは自動生成されました。
          labels: |
            automated
            sync
            commit-rules
