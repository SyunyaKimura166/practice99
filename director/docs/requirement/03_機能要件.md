# 3. 機能要件<!-- omit in toc -->

## 目次<!-- omit in toc -->

- [3.1. 機能要件概要](#31-機能要件概要)
- [3.2. 機能要件詳細](#32-機能要件詳細)
  - [FR-DA-001: Issue一覧取得](#fr-da-001-issue一覧取得)
  - [FR-DA-002: Issue内容解析と優先度判断](#fr-da-002-issue内容解析と優先度判断)
  - [FR-DA-003: タスク振り分け](#fr-da-003-タスク振り分け)
  - [FR-DA-004: GitHub Projectsステータス管理](#fr-da-004-github-projectsステータス管理)
  - [FR-DA-005: 実行レポート生成](#fr-da-005-実行レポート生成)
  - [FR-DA-006: エラーハンドリング](#fr-da-006-エラーハンドリング)
- [3.3. 使用MCPツール一覧](#33-使用mcpツール一覧)
- [3.4. Issue種別と振り分けマッピング](#34-issue種別と振り分けマッピング)

## 3.1. 機能要件概要

DirectorAgentは、GitHub Projects MCP Server経由でIssueの管理と振り分けを行う。Claude Opus 4.5による自然言語理解を活用し、Issue内容全体を解析して優先度判断とマネージャエージェントへの振り分けを実行する。

**主要機能**:
1. MCP経由でのBacklog Issue一覧取得
2. LLMによるIssue内容解析と優先度判断
3. 総合判断によるマネージャエージェント振り分け
4. GitHub ProjectsステータスとassigneesフィールドのMCP経由更新
5. 実行結果レポート生成
6. 包括的なエラーハンドリング

## 3.2. 機能要件詳細

### FR-DA-001: Issue一覧取得

**要件**:
DirectorAgentは、GitHub Projects MCP Server経由でBacklogステータスのIssue一覧を取得できること。

**入力パラメータ**:
- リポジトリオーナー名（例: "owner"）
- リポジトリ名（例: "repo-name"）
- ステータスフィルタ（"open"）
- 取得上限（最大100件）

**処理フロー**:
```
1. list_repository_issues(owner, repo, state="open", limit=100)
   → オープンなIssue一覧を取得

2. 各Issueに対して get_issue_project_info(issue_node_id)
   → プロジェクト情報とステータスを確認

3. ステータスが"Backlog"のIssueのみを抽出
   → 処理対象Issue一覧を作成
```

**出力**:
- Issue一覧（番号、タイトル、作成日、Node ID）
- 各IssueのGitHub Projectsステータス
- 現在のassigneesフィールド値
- プロジェクト情報（プロジェクトID、タイトル）

**使用MCPツール**:
- `list_repository_issues`
- `get_issue_project_info`

**制約条件**:
- Issue取得は30秒以内に完了すること
- 最大100件までのIssueを処理できること
- GitHub APIレート制限を遵守すること

**エラー処理**:
- MCP通信エラー時は最大3回リトライ
- GitHub APIエラー時は適切なエラーメッセージを出力
- Issue数が0件の場合は処理完了として終了

### FR-DA-002: Issue内容解析と優先度判断

**要件**:
DirectorAgentは、取得したIssueの内容を総合的に解析し、Claude Opus 4.5による自然言語理解と数値計算を組み合わせて優先度を判断できること。

**入力パラメータ**:
- Issue内容全体（種別、要求内容、背景・目的、スコープ、要件）
- Issue本文のテキスト
- Issue作成日時、更新日時

**処理フロー**:
```
1. Claude Opus 4.5による Issue内容の意味理解
   - テンプレートフィールドの抽出と解析
   - キーワードと文脈の分析
   - 緊急度・重要度の判定

2. 優先度観点別の該当度計算
   - 顧客要求レベル（0.0-1.0）
   - ユーザー不満レベル（0.0-1.0）
   - マーケティング効果（0.0-1.0）
   - セキュリティ重要度（0.0-1.0）
   - 不具合レベル（Critical/Major/Minor）

3. 「Tidy First?」観点の適用
   - 小さな整理の必要性判定
   - 関連Issueとの依存関係確認
   - 構造vs振る舞いの優先度判定

4. **優先度スコア計算**
   
   基本スコア = LLM総合評価スコア (1-10)
   最終スコア = 基本スコア × 時間係数 × 依存関係係数

   時間係数 = 1 + (経過日数 / 30) × 0.1  (最大1.5)
   依存関係係数 = 0.8 (他Issue待ち) ～ 1.2 (ブロッカー)
```

**特徴**:
- LLM主導の意味理解による総合判断を採用
- 複雑な重み付けテーブルから解放
- 新しい観点の追加が容易

**LLM総合評価の観点**:
| 評価観点 | LLM判断内容 | スコア影響度 |
|----------|------------|------------|
| ビジネス価値 | 顧客要求、売上への影響、市場競争力 | 高 |
| 技術的緊急度 | セキュリティリスク、システム停止リスク | 高 |
| 開発効率 | 他タスクへの影響、技術的負債 | 中 |
| ユーザー影響 | 使いやすさ、不満解消 | 中 |

**出力**:
- 各Issueの優先度スコア（数値）
- 判断理由（自然言語説明）
- 各観点の該当度と重み付け詳細
- 「Tidy First?」適用結果

**制約条件**:
- Issue解析・優先度判断は60秒以内に完了すること
- 解析失敗したIssueは手動確認用レポートを生成すること

**運用上の注意事項**:

DirectorAgentの優先度判断機能について、運用上重要な注意事項を以下に記載する。

**計算式の暫定性について**

現在の優先度計算式は運用開始時の暫定的なものであり、実際の運用データに基づく継続的な改善が前提となっている：

```
基本スコア = LLM総合評価スコア (1-10)
調整スコア = 基本スコア × 時間係数 × 依存関係係数
```

**運用中に発生する可能性のある調整**:
- **重み付けの調整**: 顧客要求、セキュリティ、緊急度等の観点別重み付けの最適化
- **評価基準の追加**: 新しい判定観点（技術的負債、市場競争力等）の追加
- **計算ロジックの改善**: 線形加算から多項式回帰や機械学習モデルへの発展
- **しきい値の調整**: スコア判定基準の組織・プロジェクト特性に合わせた調整

**継続的改善の仕組み**:
- 定期的な判定精度レビュー（月1回推奨）
- 実際のタスク完了結果との照合による妥当性検証
- プロジェクト特性の変化に応じた動的な調整
- ユーザーフィードバックに基づく改善提案の収集

**運用上の推奨事項**:
- システム導入初期は判定結果の人手による確認を推奨
- 優先度判断の根拠を記録し、改善のためのデータとして蓄積
- 組織やプロジェクトの特性に応じたカスタマイズの実施

### FR-DA-003: タスク振り分け

**要件**:
DirectorAgentは、Issue内容を総合的に解析し、適切なマネージャエージェントへタスクを振り分けできること。

**振り分けロジック**:
```
Claude Opus 4.5による総合判断:
1. Issue内容全体（種別、要求、背景・目的、スコープ、要件）を解析
2. 以下の基準で振り分け先を決定：

   不具合分析 Agents (assignees: [bug-analysis]):
   - Issue種別が「Bug」「不具合修正」
   - 内容に不具合・バグ・エラー・障害関連のキーワード
   - 既存機能の動作不良に関する記述

   DevPlanner Agents (assignees: [devplanner]):
   - 上記以外のすべて（新規開発、機能追加、リファクタ、調査等）
   - 境界ケースは内容の詳細分析により判断
```

**処理フロー**:
```
1. 最高優先度Issueの選択
   → 優先度スコアが最も高いIssueを選択

2. 振り分け先判断
   → Claude Opus 4.5による総合判断で振り分け先決定

3. assigneesフィールド更新
   → update_issue_assignees(owner, repo, issue_number, assignees)

4. 判断理由記録
   → 振り分け理由を実行レポートに記録
```

**振り分け先マッピング**:
| Issue種別 | 基本振り分け先 | assignees値 |
|----------|-------------|-------------|
| 新規開発 | DevPlanner Agents | [devplanner] |
| 機能追加 | DevPlanner Agents | [devplanner] |
| 不具合修正 | 不具合分析 Agents | [bug-analysis] |
| リファクタ | DevPlanner Agents | [devplanner] |
| 調査/分析 | DevPlanner Agents | [devplanner] |
| パフォーマンス改善 | DevPlanner Agents | [devplanner] |
| セキュリティ | DevPlanner Agents | [devplanner] |
| ドキュメント | DevPlanner Agents | [devplanner] |
| PoC / プロトタイプ | DevPlanner Agents | [devplanner] |

**使用MCPツール**:
- `update_issue_assignees`

**⚠️ assignees設定方式の暫定性について**:

現在のassignees設定方式は暫定実装であり、以下の点に留意が必要です：

- **現在方式**: Issue本文の`assignees: []`フィールドを直接編集
- **利点**: 既存Issueテンプレートとの互換性、シンプルな実装
- **課題**: 本文編集による意図しない変更リスク
- **将来検討**: GitHubラベル、GitHub Projects V2カスタムフィールド等への移行を検討中

本方式は運用開始時の暫定的なものであり、実際の運用結果に基づいて改善を行う予定です。

**出力**:
- 振り分け先エージェント名
- assignees設定値
- 判断理由の詳細記録

### FR-DA-004: GitHub Projectsステータス管理

**要件**:
DirectorAgentは、選択したIssueのGitHub Projectsステータスを「Backlog」から「Ready」に変更できること。

**入力パラメータ**:
- リポジトリオーナー名
- リポジトリ名
- Issue番号
- 現在のステータス（"Backlog"）
- 変更先ステータス（"Ready"）

**処理フロー**:
```
1. ステータス変更前の確認
   → get_issue_project_info で現在のステータスを確認

2. ステータス変更実行
   → change_issue_status_by_repo_info(owner, repo, issue_number, "Backlog", "Ready")

3. 変更結果確認
   → 更新後のステータスを確認し成功を検証
```

**ステータス遷移ルール**:
| 遷移元 | 遷移先 | 実行者 | 条件 |
|--------|--------|--------|------|
| Backlog | Ready | DirectorAgent | 優先度判断完了、振り分け先決定済み |
| Ready | Running | マネージャエージェント | ポーリングで検知、タスク着手 |
| Running | Review | ワーカーエージェント | 実装完了、PR作成 |
| Review | Merged/Reject | レビュアー | レビュー結果による |
| Reject | Backlog | システム | 再検討が必要 |

**使用MCPツール**:
- `change_issue_status_by_repo_info`
- `change_issue_status_by_node_id`（必要に応じて）

**出力**:
- ステータス変更結果（成功/失敗）
- 更新日時
- 変更前後のステータス

**制約条件**:
- ステータス変更は10秒以内に完了すること
- 変更前のステータス確認を必須とすること
- 不正なステータス遷移は拒否すること

### FR-DA-005: 実行レポート生成

**要件**:
DirectorAgentは、Issue選択・振り分け・ステータス変更の実行結果をMarkdown形式のレポートとして生成できること。

**レポート内容**:
```markdown
# DirectorAgent 実行レポート

## 実行情報
- 実行日時: {実行開始日時}
- 処理対象リポジトリ: {owner}/{repo}
- 実行モード: {手動実行/自動実行}
- 実行時間: {処理時間}
- 実行ステータス: {成功/失敗}

## Issue解析結果
- 検出されたBacklog Issue数: {件数}
- 解析対象Issue数: {件数}
- 選択されたIssue: #{issue_number} "{title}"
- 優先度スコア: {score} ({判断理由})

## 優先度判断詳細
- 顧客要求レベル: {レベル} (重み: {重み}, 該当度: {該当度})
- ユーザー不満レベル: {レベル} (重み: {重み}, 該当度: {該当度})
- マーケティング効果: {レベル} (重み: {重み}, 該当度: {該当度})
- セキュリティ重要度: {レベル} (重み: {重み}, 該当度: {該当度})
- 不具合レベル: {レベル} (重み: {重み}, 該当度: {該当度})
- Tidy First?適用: {適用結果と理由}

## 振り分け結果
- 振り分け先: {DevPlanner Agents/不具合分析 Agents}
- assignees設定: {devplanner/bug-analysis}
- ステータス変更: Backlog → Ready
- 判断理由: {詳細理由}

## 次の処理
- マネージャエージェントがポーリングでReadyステータスを検知し着手予定
- 予想処理開始時間: {推定時間}

## エラー・警告
{エラーがある場合のみ}
- {エラー詳細}
- {解決方法の提案}
```

**出力形式**:
- フォーマット: Markdown
- エンコーディング: UTF-8
- 出力先: GitHub Actions実行ログ

**制約条件**:
- レポート生成は10秒以内に完了すること
- 必要な情報が不足している場合は「不明」として記録すること

### FR-DA-006: エラーハンドリング

**要件**:
DirectorAgentは、MCP Server通信エラー、GitHub API制限、Issue解析失敗等のエラーに適切に対処できること。

**エラー分類とハンドリング**:

| エラー分類 | エラーコード | ハンドリング戦略 | リトライ |
|-----------|-------------|-----------------|---------|
| MCP通信エラー | DA-MCP-001 | Exponential Backoff | 可（最大3回） |
| GitHub API制限 | DA-API-002 | レート制限遵守待機 | 可（適切な間隔） |
| Issue解析失敗 | DA-ANALYSIS-003 | 手動確認用レポート | 不可 |
| ステータス更新失敗 | DA-STATUS-004 | ロールバック検討 | 可（最大2回） |
| 権限不足 | DA-AUTH-005 | 設定確認案内 | 不可 |
| 設定エラー | DA-CONFIG-006 | 設定修正案内 | 不可 |

**リトライ戦略**:
```
Exponential Backoff:
- 1回目: 1秒後
- 2回目: 2秒後
- 3回目: 4秒後
- 最大リトライ回数: 3回

GitHub APIレート制限:
- X-RateLimit-Resetヘッダーに基づく適切な待機
- 1時間あたりのリクエスト数監視
```

**フォールバック戦略**:
- Issue解析失敗時: 他の利用可能なIssueで処理継続
- 全Issue解析失敗時: 手動確認用レポート生成
- assignees更新失敗: ステータス変更はスキップ
- ステータス更新失敗: assignees元に戻すことを検討

**エラーレポート生成**:
```markdown
# エラーレポート

## エラー情報
- エラーコード: {コード}
- エラーメッセージ: {メッセージ}
- 発生時刻: {時刻}
- 対象Issue: #{番号} "{タイトル}"

## 対処方法
{具体的な解決手順}

## 手動確認が必要な項目
- [ ] {確認項目1}
- [ ] {確認項目2}
```

## 3.3. 使用MCPツール一覧

DirectorAgentが使用するMCPツールとその用途：

| ツール名 | 機能要件 | 用途 | 呼び出し頻度 |
|----------|----------|------|-------------|
| `list_repository_issues` | FR-DA-001 | Backlog Issue一覧取得 | 実行毎に1回 |
| `get_issue_project_info` | FR-DA-001 | Issue詳細・プロジェクト情報取得 | Issue毎に1回 |
| `update_issue_assignees` | FR-DA-003 | 担当エージェント設定 | 選択Issue毎に1回 |
| `change_issue_status_by_repo_info` | FR-DA-004 | ステータス変更（リポジトリ情報ベース） | 選択Issue毎に1回 |
| `change_issue_status_by_node_id` | FR-DA-004 | ステータス変更（Node IDベース） | 必要に応じて |
| `get_issue_node_id_from_repo_info` | FR-DA-001 | Issue Node ID取得 | 必要に応じて |
| `update_project_status` | FR-DA-004 | プロジェクトステータス更新（内部処理） | 必要に応じて |

## 3.4. Issue種別と振り分けマッピング

**テンプレート変更対応**:
- LLMによる自然言語理解ベースの解析
- 固定的なパターンマッチ非依存
- 新しい種別が追加されても自動対応

**現在定義されているIssue種別**:

| 種別 | 英語名 | 説明 | 基本振り分け先 | assignees |
|------|--------|------|-----------|----------|
| 新規開発 | New Development | 新しい機能やシステムの開発 | DevPlanner Agents | [devplanner] |
| 機能追加 | Feature | 既存システムへの機能追加 | DevPlanner Agents | [devplanner] |
| 不具合修正 | Bug | 不具合・バグの修正 | 不具合分析 Agents | [bug-analysis] |
| リファクタ | Refactor | コードの構造改善・最適化 | DevPlanner Agents | [devplanner] |
| 調査/分析 | Research | 技術調査や分析タスク | DevPlanner Agents | [devplanner] |
| パフォーマンス改善 | Perf | 処理速度・リソース効率の改善 | DevPlanner Agents | [devplanner] |
| セキュリティ | Security | セキュリティ対策・脆弱性修正 | DevPlanner Agents | [devplanner] |
| ドキュメント | Docs | ドキュメント作成・更新 | DevPlanner Agents | [devplanner] |
| PoC / プロトタイプ | Proof of Concept | 技術検証・プロトタイプ作成 | DevPlanner Agents | [devplanner] |

**境界ケース判定例**:
- セキュリティ脆弱性の**修正** → 内容次第で不具合分析 or DevPlanner
- パフォーマンス**問題の修正** → 内容次第で不具合分析 or DevPlanner
- 新機能の**バグ修正** → 不具合分析 Agents

***

[目次](./01_はじめに.md#はじめに)