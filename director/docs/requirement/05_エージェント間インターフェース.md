# 5. エージェント間インターフェース<!-- omit in toc -->

## 目次<!-- omit in toc -->

- [5.1. インターフェース概要](#51-インターフェース概要)
- [5.2. GitHub Projects MCP Server連携](#52-github-projects-mcp-server連携)
  - [5.2.1. MCP通信プロトコル](#521-mcp通信プロトコル)
  - [5.2.2. 使用MCPツール詳細](#522-使用mcpツール詳細)
  - [5.2.3. MCP操作シーケンス](#523-mcp操作シーケンス)
- [5.3. DirectorAgent ↔ マネージャエージェント連携](#53-directoragent--マネージャエージェント連携)
  - [5.3.1. 疎結合連携方式](#531-疎結合連携方式)
  - [5.3.2. ステータス・assignees連携プロトコル](#532-ステータスassignees連携プロトコル)
  - [5.3.3. マネージャエージェントポーリング仕様](#533-マネージャエージェントポーリング仕様)
- [5.4. Issueテンプレートインターフェース](#54-issueテンプレートインターフェース)
- [5.5. エラーハンドリングインターフェース](#55-エラーハンドリングインターフェース)

## 5.1. インターフェース概要

DirectorAgentは、以下の3つの主要インターフェースを通じて外部システムおよびエージェントと連携する。

**インターフェース構成図**:
```
                    ユーザー・他Agent
                        ↓ (Issue作成)
                   GitHub Issues/Projects
                        ↑↓ (GraphQL/REST API)
            ┌─────────────────────────────────────┐
            │   GitHub Projects MCP Server        │
            │   (./mcp_tool/github_projects_mcp.py) │
            └─────────────────────────────────────┘
                        ↑↓ (MCP over STDIO)
            ┌─────────────────────────────────────┐
            │        DirectorAgent               │
            │  (GitHub Actions + Claude Code)    │
            └─────────────────────────────────────┘
                        ↓ (ステータス・assignees更新)
                   GitHub Issues/Projects
                   (Status: Ready, assignees設定)
                        ↓ (ポーリング検知)
            ┌─────────────────────────────────────┐
            │      マネージャエージェント           │
            │  ├── DevPlanner Agents             │
            │  │   (assignees: devplanner)       │
            │  └── 不具合分析 Agents              │
            │      (assignees: bug-analysis)     │
            └─────────────────────────────────────┘
```

**主要インターフェース**:
1. **MCP Server連携**: GitHub Projects操作（Issue取得、ステータス変更、assignees設定）
2. **マネージャエージェント連携**: GitHub Projects経由の疎結合連携
3. **Issueテンプレート**: 構造化されたIssue情報の解析

## 5.2. GitHub Projects MCP Server連携

### 5.2.1. MCP通信プロトコル

**通信方式**: MCP (Model Context Protocol) over STDIO

**MCPサーバファイル**: `./mcp_tool/github_projects_mcp.py`

**通信設定**:
```yaml
mcp_config: |
  {
    "mcpServers": {
      "github-projects": {
        "command": "python",
        "args": ["docs/requirement/mcp_tool/github_projects_mcp.py"]
      }
    }
  }
```

**認証設定**:
- GitHub Token: `GITHUB_TOKEN` 環境変数
- GitHub Permissions: `contents: read`, `issues: write`

### 5.2.2. 使用MCPツール詳細

#### `list_repository_issues`

**用途**: Backlog Issue一覧の取得

**入力パラメータ**:
```json
{
  "owner": "string (required)",
  "repo": "string (required)",
  "state": "open (default)",
  "labels": ["array of strings (optional)"],
  "limit": "integer (default: 30, max: 100)"
}
```

**出力**:
```json
{
  "data": {
    "search": {
      "issueCount": 15,
      "edges": [
        {
          "node": {
            "id": "I_kwDOABCD123",
            "number": 123,
            "title": "新機能XXXの実装",
            "state": "OPEN",
            "createdAt": "2025-12-11T09:00:00Z",
            "labels": {
              "nodes": [
                {"name": "feature", "color": "0366d6"}
              ]
            },
            "projectItems": {
              "nodes": [
                {
                  "id": "PVTI_lADOABCD123",
                  "project": {
                    "id": "PVT_kwDOABCD123",
                    "title": "Development Board"
                  },
                  "fieldValues": {
                    "nodes": [
                      {
                        "name": "Backlog",
                        "field": {"name": "Status"}
                      }
                    ]
                  }
                }
              ]
            }
          }
        }
      ]
    }
  }
}
```

#### `get_issue_project_info`

**用途**: 特定IssueのProject情報・ステータス取得

**入力パラメータ**:
```json
{
  "issue_node_id": "I_kwDOABCD123"
}
```

**出力**:
```json
{
  "data": {
    "node": {
      "number": 123,
      "title": "新機能XXXの実装",
      "projectItems": {
        "nodes": [
          {
            "id": "PVTI_lADOABCD123",
            "project": {
              "id": "PVT_kwDOABCD123",
              "title": "Development Board"
            },
            "fieldValues": {
              "nodes": [
                {
                  "name": "Backlog",
                  "optionId": "47fc9ee4",
                  "field": {
                    "id": "PVTSSF_lADOABCD123",
                    "name": "Status",
                    "options": [
                      {"id": "47fc9ee4", "name": "Backlog"},
                      {"id": "1e3a2c5f", "name": "Ready"},
                      {"id": "6b7d9a1c", "name": "Running"},
                      {"id": "2f8e5b3d", "name": "Review"},
                      {"id": "9a4c7f2e", "name": "Reject"},
                      {"id": "5e1b8d6a", "name": "Merged"}
                    ]
                  }
                }
              ]
            }
          }
        ]
      }
    }
  }
}
```

#### `update_issue_assignees`

**用途**: Issue本文のassigneesフィールド編集

**入力パラメータ**:
```json
{
  "owner": "owner-name",
  "repo": "repo-name",
  "issue_number": 123,
  "assignees": ["devplanner"]
}
```

**処理内容**:
1. Issue本文をGitHub REST API経由で取得
2. `assignees: []` パターンを検索
3. 指定されたassigneesで置換：`assignees: [devplanner]`
4. Issue本文をREST API経由で更新

**出力（成功時）**:
```json
{
  "success": true,
  "issue_number": 123,
  "assignees": ["devplanner"],
  "updated_at": "2025-12-11T09:15:30Z"
}
```

**出力（エラー時）**:
```json
{
  "error": "Issue本文にassigneesフィールドが見つかりません",
  "details": "Issueテンプレートに \"assignees: []\" が含まれていることを確認してください"
}
```

#### `change_issue_status_by_repo_info`

**用途**: GitHub Projectsステータス変更

**入力パラメータ**:
```json
{
  "owner": "owner-name",
  "repo": "repo-name",
  "issue_number": 123,
  "from_status": "Backlog",
  "to_status": "Ready"
}
```

**処理フロー**:
1. Issue Node ID取得
2. プロジェクト情報取得・現在ステータス確認
3. from_statusとの整合性確認
4. ステータスフィールド・オプションID解決
5. GraphQL Mutation実行

**出力（成功時）**:
```json
{
  "success": true,
  "issue": {
    "number": 123,
    "title": "新機能XXXの実装",
    "node_id": "I_kwDOABCD123"
  },
  "project": {
    "id": "PVT_kwDOABCD123",
    "title": "Development Board"
  },
  "status_change": {
    "from": "Backlog",
    "to": "Ready"
  },
  "update_response": {
    "data": {
      "updateProjectV2ItemFieldValue": {
        "projectV2Item": {"id": "PVTI_lADOABCD123"}
      }
    }
  }
}
```

### 5.2.3. MCP操作シーケンス

DirectorAgentのMCP操作は以下の順序で実行される：

```
1. list_repository_issues(owner, repo, state="open", limit=100)
   → オープンなIssue一覧を取得

2. 各Issue毎に get_issue_project_info(issue_node_id)
   → プロジェクト情報とステータスを取得
   → ステータス="Backlog" のIssueのみを抽出

3. [Claude Opus 4.5による Issue内容解析・優先度判断]
   → 最優先Issueを選択
   → 振り分け先エージェント決定

4. update_issue_assignees(owner, repo, issue_number, assignees)
   → 担当エージェント設定（devplanner or bug-analysis）

5. change_issue_status_by_repo_info(owner, repo, issue_number, "Backlog", "Ready")
   → ステータス変更（Backlog → Ready）
```

**エラーハンドリング**:
- 各MCP呼び出しで個別エラー処理
- 指数バックオフでのリトライ（最大3回）
- GitHub APIレート制限の監視と待機

## 5.3. DirectorAgent ↔ マネージャエージェント連携

### 5.3.1. 疎結合連携方式

DirectorAgentとマネージャエージェント間は、**GitHub Projectsを仲介とした疎結合連携**を採用する。

**連携の特徴**:
- 直接通信なし（非同期・疎結合）
- GitHub Projects上のステータス・assigneesによる情報共有
- マネージャエージェントによるポーリング検知
- 障害時の独立性確保

**利点**:
- エージェント間の独立性確保
- GitHub Projectsによる可視性
- 障害影響の局所化
- 実装・デバッグの簡素化

### 5.3.2. ステータス・assignees連携プロトコル

#### DirectorAgent → マネージャエージェント

**DirectorAgentが設定する情報**:

| 設定項目 | 設定値 | 用途 |
|---------|--------|------|
| **GitHub Projectsステータス** | "Ready" | マネージャエージェントが検知すべき状態 |
| **Issue assignees (Bug系)** | `[bug-analysis]` | 不具合分析 Agentsに振り分け |
| **Issue assignees (その他)** | `[devplanner]` | DevPlanner Agentsに振り分け |

**設定処理詳細**:
```
Phase 1: assignees設定
  update_issue_assignees(owner, repo, issue_number, ["devplanner"])
  → Issue本文: "assignees: []" → "assignees: [devplanner]"

Phase 2: ステータス変更
  change_issue_status_by_repo_info(owner, repo, issue_number, "Backlog", "Ready")
  → GitHub Projects: Backlog → Ready
```

#### マネージャエージェント → DirectorAgent

**マネージャエージェントが更新する情報**:

| 設定項目 | 設定値 | 意味 |
|---------|--------|------|
| **GitHub Projectsステータス** | "Running" | タスク着手済み（競合回避） |
| **処理開始ログ** | Issue コメント（オプション） | 処理開始の記録 |

### 5.3.3. マネージャエージェントポーリング仕様

#### ポーリング設定

| 項目 | 推奨値 | 理由 |
|------|--------|------|
| **ポーリング間隔** | 5-10分 | リアルタイム性とAPI制限のバランス |
| **検知クエリ** | GraphQL Projects API | 効率的なフィルタリング |
| **並行処理数** | 1件ずつ | 競合状態の回避 |

#### ポーリング処理フロー

```python
# マネージャエージェントのポーリング処理例
def poll_ready_issues(agent_type):
    """
    agent_type: "devplanner" または "bug-analysis"
    """

    # 1. Ready状態かつ自担当のIssueを検索
    query = f"""
      repo:{owner}/{repo} is:issue is:open
      project:{project_name}
      assignees:{agent_type}
    """

    issues = github_search(query)

    for issue in issues:
        # 2. プロジェクトステータス確認
        project_status = get_project_status(issue.node_id)

        if project_status == "Ready":
            # 3. ステータス更新（競合回避）
            try:
                update_status(issue.node_id, "Ready", "Running")
                # 4. タスク処理開始
                start_task_processing(issue)

            except StatusConflictError:
                # 他エージェントが先に着手済み
                continue
```

#### 競合制御メカニズム

**楽観的ロック方式**:
- ステータス更新時に現在値を確認
- 期待値と異なる場合はエラーとして処理
- 複数エージェントの同時着手を防止

**競合シナリオ例**:
```
時刻T1: AgentA が Issue#123 の Ready を検知
時刻T1: AgentB も Issue#123 の Ready を検知
時刻T2: AgentA が Ready→Running に更新（成功）
時刻T2: AgentB が Ready→Running に更新（失敗: 現在値はRunning）
時刻T3: AgentB は他のIssueを探索
```

## 5.4. Issueテンプレートインターフェース

### 5.4.1. テンプレート構造

**ファイル**: `./issue_template/template.md`

**構造概要**:
```markdown
title: "{種別} - {短い説明}"
assignees: []  # DirectorAgentが編集

---

### 1. Projects ステータス
- [ ] Backlog    # 新規作成時
- [ ] Ready      # DirectorAgent処理後
- [ ] Running    # マネージャエージェント着手後
- [ ] Review
- [ ] Reject
- [ ] Merged

### 2. 種別
- [ ] 新規開発（New Development）
- [ ] 機能追加（Feature）
- [ ] 不具合修正（Bug）           # 不具合分析 Agents
- [ ] リファクタ（Refactor）
- [ ] 調査/分析（Research）
- [ ] パフォーマンス改善（Perf）
- [ ] セキュリティ（Security）
- [ ] ドキュメント（Docs）
- [ ] PoC / プロトタイプ（Proof of Concept）

### 3. 要求
{顧客要求、ユーザ不満、市場ニーズなど - 優先度判断に使用}

### 4. 背景・目的
背景: {なぜこのタスクが必要か}
目的: {何を達成したいか}

### 5. スコープ
対象: {実装範囲}
非対象: {実装しない範囲}

### 6. 要件
機能要件: {どのような機能}
非機能要件: {性能、可用性等}
```

### 5.4.2. DirectorAgentによる解析方式

**総合判断アプローチ**:
- **従来**: 種別フィールドのみでルールベース振り分け
- **新方式**: Issue内容全体をLLM（Claude Opus 4.5）で意味理解

**解析対象フィールド**:

| フィールド | 解析用途 | 重要度 |
|-----------|----------|--------|
| **種別** | 基本的な振り分け判断 | 高 |
| **要求** | 優先度スコア計算、振り分け補完判断 | 高 |
| **背景・目的** | コンテキスト理解、総合判断 | 中 |
| **スコープ** | 作業範囲理解、振り分け判断 | 中 |
| **要件** | 技術的複雑さ理解、振り分け判断 | 中 |
| **タイトル** | 概要把握、キーワード抽出 | 低 |

**振り分け判断ロジック**:
```python
# 擬似コード（実際はLLMが自然言語で判断）
def determine_assignee(issue_content):
    # 1. 種別による基本判断
    if issue_type == "Bug" or issue_type == "不具合修正":
        base_assignee = "bug-analysis"
    else:
        base_assignee = "devplanner"

    # 2. 内容による総合判断
    if contains_bug_keywords(issue_content.要求, issue_content.背景目的):
        return "bug-analysis"
    elif contains_investigation_keywords(issue_content):
        return "devplanner"
    else:
        return base_assignee

def contains_bug_keywords(text):
    # LLMが以下のような内容を検出
    bug_patterns = [
        "エラーが発生", "バグ", "正常に動作しない",
        "例外", "障害", "不具合", "クラッシュ",
        "動作がおかしい", "期待通りに動かない"
    ]
    return llm_semantic_match(text, bug_patterns)
```

### 5.4.3. テンプレート変更耐性

**対応可能な変更**:

| 変更種類 | 対応方法 | 例 |
|---------|----------|-----|
| **種別追加** | LLM自動認識 | "技術負債解消" → DevPlanner自動振り分け |
| **種別名変更** | 意味理解で対応 | "Bug" → "バグ修正" → 意味は同じと判断 |
| **フィールド追加** | LLM自動解析 | "### 緊急度" → 優先度計算に自動反映 |
| **構造変更** | 柔軟な解析 | セクション順序変更にも対応 |

**変更例**:
```markdown
# 変更前
### 2. 種別
- [ ] 新規開発
- [ ] 不具合修正

# 変更後（自動対応）
### 2. 種別
- [ ] 新規開発
- [ ] 不具合修正
- [ ] 緊急対応     # 新規追加 → LLMが自動認識・振り分け
- [ ] 技術負債解消  # 新規追加 → DevPlanner自動振り分け
```

## 5.5. エラーハンドリングインターフェース

### 5.5.1. エラー分類

| エラーカテゴリ | エラーコード | 説明 | 復旧方法 |
|-------------|-------------|------|----------|
| **MCP通信** | DA-MCP-001 | MCP Server接続失敗 | リトライ（指数バックオフ） |
| **MCP通信** | DA-MCP-002 | MCPツール呼び出し失敗 | パラメータ確認・リトライ |
| **GitHub API** | DA-API-001 | GitHub API レート制限 | X-RateLimit-Reset待機 |
| **GitHub API** | DA-API-002 | GitHub API認証エラー | GITHUB_TOKEN確認 |
| **Issue操作** | DA-ISSUE-001 | Issue本文解析失敗 | テンプレート形式確認 |
| **Issue操作** | DA-ISSUE-002 | assigneesフィールド未発見 | テンプレート修正 |
| **ステータス** | DA-STATUS-001 | ステータス更新失敗 | 現在ステータス確認 |
| **ステータス** | DA-STATUS-002 | ステータス競合 | 他エージェント動作確認 |

### 5.5.2. エラーレスポンス形式

**MCPツールエラーレスポンス**:
```json
{
  "error": "DA-MCP-001: MCP Server接続失敗",
  "details": "github-projects server が応答しません",
  "timestamp": "2025-12-11T09:15:30Z",
  "issue_context": {
    "issue_number": 123,
    "operation": "change_issue_status_by_repo_info"
  },
  "retry_info": {
    "attempt": 2,
    "max_attempts": 3,
    "next_retry_after": "2025-12-11T09:15:32Z"
  }
}
```

**GitHub Actions ログ出力**:
```
::error title=DirectorAgent Error::DA-STATUS-002: ステータス競合が発生しました
Issue #123 のステータスが期待される 'Backlog' ではなく 'Running' でした。
他のエージェントによって先に処理された可能性があります。

詳細:
- Issue: #123 "新機能XXXの実装"
- 期待ステータス: Backlog
- 実際ステータス: Running
- 最終更新: 2025-12-11T09:10:00Z

推奨対処法:
1. 他のReadyステータスのIssueがないか確認
2. マネージャエージェントの動作状況を確認
3. 必要に応じて手動でステータスを調整
```

### 5.5.3. エラー復旧戦略

#### 自動復旧可能エラー

| エラー種類 | 復旧戦略 | 設定 |
|----------|----------|------|
| **MCP接続失敗** | 指数バックオフリトライ | 1s, 2s, 4s (最大3回) |
| **GitHub APIレート制限** | 制限解除まで待機 | X-RateLimit-Resetヘッダー監視 |
| **一時的なAPI障害** | 短時間待機してリトライ | 30秒待機後1回リトライ |

#### 手動復旧必要エラー

| エラー種類 | 対処法 | 通知方法 |
|----------|--------|----------|
| **Issue解析失敗** | テンプレート修正 | 詳細ログ出力 |
| **権限不足** | GitHub permissions設定確認 | GitHub Actions失敗通知 |
| **設定エラー** | MCP設定・環境変数確認 | GitHub Actions失敗通知 |

***

[目次](./01_はじめに.md#はじめに)