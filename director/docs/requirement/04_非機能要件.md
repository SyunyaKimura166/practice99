# 4. 非機能要件<!-- omit in toc -->

## 目次<!-- omit in toc -->

- [4.1. 非機能要件概要](#41-非機能要件概要)
- [4.2. 性能要件](#42-性能要件)
  - [NFR-DA-001: 応答時間](#nfr-da-001-応答時間)
  - [NFR-DA-002: スループット](#nfr-da-002-スループット)
- [4.3. 可用性要件](#43-可用性要件)
  - [NFR-DA-003: サービス稼働率](#nfr-da-003-サービス稼働率)
  - [NFR-DA-004: 障害復旧](#nfr-da-004-障害復旧)
- [4.4. セキュリティ要件](#44-セキュリティ要件)
  - [NFR-DA-005: 認証・認可](#nfr-da-005-認証認可)
  - [NFR-DA-006: 監査ログ](#nfr-da-006-監査ログ)
- [4.5. 保守性要件](#45-保守性要件)
  - [NFR-DA-007: ログ出力](#nfr-da-007-ログ出力)
  - [NFR-DA-008: 監視・アラート](#nfr-da-008-監視アラート)
- [4.6. 拡張性要件](#46-拡張性要件)
  - [NFR-DA-009: テンプレート変更耐性](#nfr-da-009-テンプレート変更耐性)
  - [NFR-DA-010: マネージャエージェント追加対応](#nfr-da-010-マネージャエージェント追加対応)
- [4.7. GitHub Actions実行環境](#47-github-actions実行環境)

## 4.1. 非機能要件概要

DirectorAgentは**PoC（Proof of Concept）として機能優先で作成**するため、非機能要件を以下の2段階に分けて定義する：

- **PoC要件**: 基本機能を確認するための最低限の非機能要件
- **理想形要件**: 本格運用時に達成すべき非機能要件

DirectorAgentの非機能要件（NFR: Non-Functional Requirements）は、GitHub ActionsとClaude Code、MCPサーバを組み合わせた環境での運用を前提とする。

**主要非機能要件カテゴリ**:
1. 性能要件（応答時間、スループット）
2. 可用性要件（稼働率、障害復旧）
3. セキュリティ要件（認証・認可、監査ログ）
4. 保守性要件（ログ出力、監視・アラート）
5. 拡張性要件（テンプレート変更耐性、エージェント追加対応）

## 4.2. 性能要件

### NFR-DA-001: 応答時間

**PoC要件**:
DirectorAgentの基本機能確認に必要な最低限の応答時間要件。

| 処理カテゴリ | 処理項目 | PoC目標時間 | 備考 |
|------------|----------|------------|------|
| **全体処理** | **DirectorAgent 1回実行** | **15分以内** | GitHub Actions標準タイムアウト |
| **Issue取得** | `list_repository_issues` | 60秒以内 | 基本動作確認レベル |
| **Issue解析** | Issue内容解析・優先度判断 | 120秒以内 | 精度重視、速度は二の次 |
| **Issue操作** | assignees/status更新 | 30秒以内 | 確実な動作を優先 |

**理想形要件**:
本格運用時に達成すべき応答時間要件。

| 処理カテゴリ | 処理項目 | 理想形目標時間 | 制約・備考 |
|------------|----------|-------------|-----------|
| **MCP接続** | MCP Server起動・接続確立 | 10秒以内 | Python環境セットアップ含む |
| **Issue取得** | `list_repository_issues` | 30秒以内 | GitHub API制限考慮 |
| **Issue解析** | `get_issue_project_info` (1件) | 10秒以内 | GraphQL API 1回呼び出し |
| **Issue解析** | Issue内容解析・優先度判断 (1件) | 60秒以内 | Claude Opus 4.5による自然言語理解 |
| **Issue解析** | 全Issue優先度判断 (最大100件) | 300秒以内 | 5分以内で全体完了 |
| **Issue操作** | `update_issue_assignees` | 10秒以内 | REST API経由、Issue本文編集 |
| **Issue操作** | `change_issue_status_by_repo_info` | 10秒以内 | GraphQL Mutation |
| **レポート** | 実行レポート生成 | 10秒以内 | Markdown形式、ログ出力 |
| **全体処理** | **DirectorAgent 1回実行** | **10分以内** | **GitHub Actionsタイムアウト制限** |

**制約条件**:
- GitHub ActionsのワークフローレベルでTimeout設定（PoC: 15分、理想形: 10分）
- Claude API呼び出しの個別タイムアウト（60秒/リクエスト）
- MCP通信のエラー時リトライを含む（最大3回）

### NFR-DA-002: スループット

**PoC要件**:
基本機能確認に必要な最低限のスループット要件。

| 項目 | PoC目標値 | 備考 |
|------|---------|------|
| **手動実行頻度** | 1日20回まで | 開発・テスト段階の頻繁実行に対応 |
| **処理Issue上限** | 10件/回 | 小規模テスト向け |
| **実行間隔** | 手動実行のみ | 自動化は後回し |

**理想形要件**:
本格運用時に達成すべきスループット要件。

| 実行フェーズ | 項目 | 理想形目標値 | 備考 |
|------------|------|----------|------|
| **Phase 1** | 手動実行頻度 | 1日10回まで | workflow_dispatch（開発・テスト段階） |
| **Phase 1** | 処理Issue上限 | 100件/回 | `list_repository_issues` limit |
| **Phase 2** | 定期実行間隔 | 6時間毎 | cron: '0 */6 * * *'（安定運用段階） |
| **Phase 2** | 1日あたり処理Issue数 | 最大400件 | 4回/日 × 100件/回 |
| **Phase 3** | 自動実行判断間隔 | 状況に応じて変動 | AI判断ベース（完全自動化段階） |
| **Phase 3** | 動的スループット最適化 | 需要に応じて調整 | リソース使用状況を総合判断 |
| **全フェーズ** | GitHub API制限遵守 | 5000 requests/hour | GraphQL + REST API合算 |
| **全フェーズ** | Claude API制限遵守 | モデル依存 | Opus 4.5の制限内 |

**制限対応**:
- GitHub APIレート制限: `X-RateLimit-Reset`ヘッダー監視
- Claude APIレート制限: 指数バックオフでリトライ
- 同時実行制御: GitHub Actions concurrency設定

## 4.3. 可用性要件

### NFR-DA-003: サービス稼働率

**PoC要件**:
基本機能確認段階では可用性よりも機能の動作確認を優先。

| コンポーネント | PoC目標稼働率 | 備考 |
|--------------|-------------|------|
| **DirectorAgent全体** | **80%以上** | 開発・テスト段階、障害許容度高 |
| **手動実行成功率** | 70%以上 | 失敗時は手動再実行で対処 |

**理想形要件**:
本格運用時に達成すべき稼働率要件。

| コンポーネント | 理想形目標稼働率 | 依存関係・備考 |
|--------------|-------------|-------------|
| **GitHub Actions** | GitHub SLA準拠 (99.9%+) | GitHubサービス依存、コントロール不可 |
| **Claude Code Action** | 99.5%以上 | Anthropic APIサービス依存 |
| **MCP Server** | 99.0%以上 | GitHub Actions環境内で実行 |
| **GitHub Projects API** | GitHub SLA準拠 | GitHub APIサービス依存 |
| **全体システム** | **99.0%以上** | **各コンポーネントの組み合わせ** |

**計画メンテナンス**:
- DirectorAgent: メンテナンス不要（ステートレス）
- 依存サービス: GitHub、Anthropicの計画メンテナンスに従う

### NFR-DA-004: 障害復旧

**要件**:
DirectorAgentは、各種障害シナリオに対して以下の復旧戦略を実行すること。

| 障害種類 | 検知方法 | 復旧戦略 | RTO | 備考 |
|----------|----------|----------|-----|------|
| **GitHub Actions失敗** | ワークフロー失敗通知 | 手動再実行 | 即時 | workflow_dispatch |
| **MCP通信エラー** | エラーログ | 指数バックオフリトライ | 30秒以内 | 最大3回 |
| **GitHub API制限** | HTTP 403応答 | レート制限解除待機 | 1時間以内 | リセット時刻まで待機 |
| **Claude API障害** | API応答エラー | 次回実行時リトライ | 6時間以内 | Phase 2自動実行 |
| **Issue解析失敗** | 例外発生 | 手動確認レポート生成 | 即時 | 処理続行 |

**データ復旧**:
- **RTO**: 0分（ステートレス設計）
- **RPO**: 0分（ステートを保持しない）
- **バックアップ**: 不要（GitHubにすべてのデータが保存済み）

## 4.4. セキュリティ要件

### NFR-DA-005: 認証・認可

**PoC要件**:
基本機能確認に必要な最低限のセキュリティ要件。

- GitHub Token: `GITHUB_TOKEN` (GitHub Actions自動発行)
- Claude API Key: `ANTHROPIC_API_KEY` (GitHub Secretsで管理)
- 基本的なアクセス制御のみ実装

**理想形要件**:
本格運用時に達成すべきセキュリティ要件。

DirectorAgentは、最小権限の原則に基づき以下の認証・認可を実装すること。

#### GitHub認証・認可

| 項目 | 設定値 | 詳細 |
|------|--------|------|
| **認証トークン** | `GITHUB_TOKEN` | GitHub Actions自動発行 |
| **トークンスコープ** | リポジトリ権限のみ | Organization権限は使用しない |
| **permissions設定** | 最小必要権限 | 以下詳細参照 |

```yaml
permissions:
  contents: read          # リポジトリ内容の読み取り（MCPサーバファイル）
  issues: write          # Issue本文編集（assigneesフィールド）
  pull-requests: write   # 将来拡張時のPR操作（現在未使用）
```

#### Anthropic API認証

| 項目 | 設定値 | 詳細 |
|------|--------|------|
| **認証キー** | `ANTHROPIC_API_KEY` | GitHub Secretsで管理 |
| **アクセス制御** | リポジトリレベル | Organization Secretsは使用しない |
| **ローテーション** | 手動 | 定期的なキー更新推奨 |

#### セキュリティベストプラクティス

- **秘密情報の暗号化**: GitHub Secrets使用
- **ログマスキング**: 自動的にトークンをマスク
- **実行時権限**: 実行時のみ権限付与
- **監査証跡**: GitHub Actionsログで追跡可能

### NFR-DA-006: 監査ログ

**要件**:
DirectorAgentは、セキュリティと運用の観点から以下の監査ログを記録すること。

#### 監査対象イベント

| カテゴリ | イベント | 記録内容 | 記録レベル |
|---------|----------|----------|----------|
| **実行制御** | 実行開始 | 実行日時、トリガー種別、実行者 | INFO |
| **実行制御** | 実行完了 | 処理時間、結果ステータス | INFO |
| **認証** | MCP接続 | 接続開始・完了、接続先 | INFO |
| **認証** | GitHub API呼び出し | APIエンドポイント、レスポンスコード | DEBUG |
| **データアクセス** | Issue一覧取得 | 取得件数、フィルタ条件 | INFO |
| **データアクセス** | Issue詳細取得 | Issue番号、取得成功/失敗 | INFO |
| **データ変更** | assignees更新 | Issue番号、変更前後の値 | INFO |
| **データ変更** | ステータス更新 | Issue番号、変更前後のステータス | INFO |
| **エラー** | 処理エラー | エラーコード、メッセージ、Issue番号 | ERROR |
| **エラー** | API制限 | 制限種類、リセット時刻 | WARN |

#### ログ保持・管理

| 項目 | 設定 |
|------|------|
| **保持期間** | 90日（GitHub Actionsログ保持期間） |
| **ログレベル** | INFO以上を記録 |
| **ログフォーマット** | タイムスタンプ + レベル + メッセージ |
| **アクセス制御** | リポジトリ管理者のみ |

## 4.5. 保守性要件

### NFR-DA-007: ログ出力

**PoC要件**:
基本的なデバッグとトラブルシューティングに必要な最低限のログ出力。

- GitHub Actionsの標準出力への基本ログ
- エラー発生時の詳細情報出力
- 実行結果の簡単なサマリー出力

**理想形要件**:
本格運用時に達成すべきログ出力要件。

DirectorAgentは、運用・保守の観点から以下の構造化されたログを出力すること。

#### ログフォーマット

```
[タイムスタンプ] [レベル] [コンポーネント] メッセージ (詳細情報)
```

**実例**:
```
::group::DirectorAgent実行開始
[2025-12-11T09:00:00.123Z] [INFO] DirectorAgent: 実行開始 (トリガー: workflow_dispatch, リポジトリ: owner/repo)
[2025-12-11T09:00:01.456Z] [INFO] MCP: 接続確立完了 (github-projects server)
::endgroup::

::group::Issue一覧取得
[2025-12-11T09:00:02.789Z] [INFO] Issue: 一覧取得開始 (state: open, limit: 100)
[2025-12-11T09:00:05.123Z] [INFO] Issue: Backlog抽出完了 (全体: 15件, Backlog: 8件)
::endgroup::

::group::優先度判断
[2025-12-11T09:00:06.456Z] [INFO] Priority: 解析開始 (対象: 8件)
[2025-12-11T09:01:15.789Z] [INFO] Priority: 最優先選択完了 (Issue #123, スコア: 4.2)
::endgroup::

::group::Issue操作
[2025-12-11T09:01:16.123Z] [INFO] Issue: assignees更新 (Issue #123: [] → [devplanner])
[2025-12-11T09:01:18.456Z] [INFO] Issue: ステータス変更 (Issue #123: Backlog → Ready)
::endgroup::

::group::実行結果
[2025-12-11T09:01:20.789Z] [INFO] Report: 実行レポート生成完了
[2025-12-11T09:01:21.123Z] [INFO] DirectorAgent: 実行完了 (処理時間: 1分21秒, ステータス: SUCCESS)
::endgroup::
```

#### ログレベル定義

| レベル | 用途 | 出力条件 |
|--------|------|----------|
| **DEBUG** | 詳細なデバッグ情報 | 開発時のみ（本番では無効） |
| **INFO** | 正常な処理の進行状況 | 常に出力 |
| **WARN** | 警告（処理は継続可能） | 常に出力 |
| **ERROR** | エラー（処理失敗） | 常に出力 |

### NFR-DA-008: 監視・アラート

**要件**:
DirectorAgentは、運用監視とアラート通知のため以下の仕組みを提供すること。

#### 監視項目

| 監視対象 | 監視方法 | 正常条件 | 異常条件 |
|----------|----------|----------|----------|
| **ワークフロー成功率** | GitHub Actions結果 | 成功率 ≥ 95% | 3回連続失敗 |
| **処理時間** | ログから算出 | ≤ 10分 | > 10分（タイムアウト） |
| **Issue処理数** | レポートから取得 | ≥ 1件/回 | 0件が3回連続 |
| **エラー発生率** | ログから算出 | ≤ 5% | > 20% |
| **GitHub API制限** | APIレスポンス | 残り > 100 requests | 制限到達 |

#### アラート通知

| アラート種類 | 通知方法 | 通知タイミング | 通知先 |
|------------|----------|-------------|--------|
| **ワークフロー失敗** | GitHub Actions通知 | 失敗時即座 | リポジトリ管理者 |
| **連続失敗** | メール | 3回連続失敗時 | 開発チーム |
| **API制限到達** | ログ警告 | 制限到達時 | ログ監視 |

#### 監視ダッシュボード

**GitHub Actions Insights**:
- ワークフロー実行履歴
- 成功率の推移
- 実行時間の推移
- 失敗原因の分析

## 4.6. 拡張性要件

### NFR-DA-009: テンプレート変更耐性

**要件**:
DirectorAgentは、Issueテンプレートの変更に対してコード変更なしで対応できること。

#### 対応可能な変更

| 変更種類 | 対応方法 | 再デプロイ要否 | 設定変更要否 |
|----------|----------|-------------|-------------|
| **新Issue種別追加** | LLM自動認識 | 不要 | 不要 |
| **種別名称変更** | 意味理解による対応 | 不要 | 不要 |
| **新フィールド追加** | LLM自動解析 | 不要 | 不要 |
| **フィールド名変更** | 意味理解による対応 | 不要 | 不要 |
| **振り分けロジック大幅変更** | プロンプト調整 | 不要 | 要（プロンプト更新） |

#### 実装方式

**自然言語理解ベース**:
```
従来: パターンマッチ
- [ ] Bug → if "Bug" checked then assign to bug-analysis

新方式: 意味理解
- LLMがIssue全体を読み、不具合・バグ・エラー関連の意味を理解
- 種別名が「バグ修正」「不具合対応」「障害対応」に変わっても自動認識
```

**テンプレート変更例**:
```markdown
# 変更前
### 2. 種別
- [ ] 新規開発
- [ ] 機能追加
- [ ] 不具合修正

# 変更後（自動対応）
### 2. 種別
- [ ] 新規開発
- [ ] 機能追加
- [ ] 不具合修正
- [ ] セキュリティ対応  # 新規追加
- [ ] 技術負債解消     # 新規追加
```

### NFR-DA-010: マネージャエージェント追加対応

**要件**:
DirectorAgentは、新しいマネージャエージェントの追加に柔軟に対応できること。

#### 拡張方法

| 拡張項目 | 方法 | 設定場所 | 例 |
|----------|------|----------|-----|
| **新assignees追加** | プロンプト更新 | GitHub Actionsワークフロー | `[security-audit]` |
| **振り分けルール追加** | 判断ロジック更新 | プロンプト内の条件分岐 | セキュリティ → security-audit |
| **優先度重み調整** | 重み付けテーブル更新 | プロンプト内の設定値 | セキュリティ重み: 2.0 |

#### 設定例

**新規マネージャエージェント: Security Audit Agent**

```yaml
# プロンプト更新例
prompt: |
  Issue内容を解析して以下の基準で振り分けてください：

  1. セキュリティ関連かつCritical → assignees: [security-audit]
  2. 不具合・バグ関連 → assignees: [bug-analysis]
  3. その他（開発・機能追加等） → assignees: [devplanner]
```

**エージェント構成の拡張**:
```
DirectorAgent
    ↓
┌──────────────────┬──────────────────┬──────────────────┐
│ DevPlanner Agent │ 不具合分析 Agent  │ Security Agent   │ ← 新規追加
│ (devplanner)     │ (bug-analysis)   │ (security-audit) │
└──────────────────┴──────────────────┴──────────────────┘
```

## 4.7. GitHub Actions実行環境

### 4.7.1. ランナー環境

| 項目 | 設定値 | 理由・備考 |
|------|--------|-----------|
| **ランナー** | `ubuntu-latest` | 標準的な環境、コスト効率 |
| **タイムアウト** | 10分 | Claude API応答時間を考慮 |
| **同時実行制御** | `concurrency: director-agent` | 重複実行防止 |
| **キャンセル設定** | `cancel-in-progress: false` | 実行中の処理を保護 |

### 4.7.2. 依存関係

| コンポーネント | バージョン | インストール方法 |
|--------------|----------|-----------------|
| **Python** | 3.11+ | `actions/setup-python@v5` |
| **Claude Code Action** | v1 | `anthropics/claude-code-action@v1` |
| **FastMCP** | latest | `pip install fastmcp` |
| **MCP Dependencies** | 自動解決 | MCPサーバファイル内で定義 |

### 4.7.3. 実行構成例

```yaml
name: DirectorAgent

on:
  workflow_dispatch:
    inputs:
      target_repository:
        description: '対象リポジトリ（省略時は実行リポジトリ）'
        required: false
        type: string
  schedule:
    - cron: '0 */6 * * *'  # 6時間毎（Phase 2）

concurrency:
  group: director-agent
  cancel-in-progress: false

jobs:
  director:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install MCP dependencies
        run: |
          pip install fastmcp
          pip install -r docs/requirement/mcp_tool/requirements.txt

      - name: Run DirectorAgent
        uses: anthropics/claude-code-action@v1
        with:
          prompt: |
            あなたはDirectorAgentです。GitHub Projects MCP Serverを使用して以下を実行：

            1. Backlogステータスのissue一覧取得
            2. 優先度判断（「Tidy First?」観点含む）
            3. 最優先issueの選択と振り分け判断
            4. assignees設定とステータス変更
            5. 実行レポート生成

            対象リポジトリ: ${{ github.repository }}

          mcp_config: |
            {
              "mcpServers": {
                "github-projects": {
                  "command": "python",
                  "args": ["docs/requirement/mcp_tool/github_projects_mcp.py"]
                }
              }
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Upload execution report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: director-agent-report
          path: |
            *.md
            *.log
```

***

[目次](./01_はじめに.md#はじめに)