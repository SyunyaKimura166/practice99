# 3. 同時並行でのワークフロー実行<!-- omit in toc -->

複数のIssue/PRに対してGitHub ActionsでClaude Codeを同時実行する場合の挙動と注意点について記載する。

## 目次<!-- omit in toc -->

- [3.1. 概要](#31-概要)
- [3.2. GitHub Actionsの並列実行仕様](#32-github-actionsの並列実行仕様)
  - [3.2.1. 同時実行ジョブ数の制限](#321-同時実行ジョブ数の制限)
  - [3.2.2. 並列実行の仕組み](#322-並列実行の仕組み)
- [3.3. 複数Issue/PRでの同時実行](#33-複数issueprでの同時実行)
  - [3.3.1. 基本的な並列実行の挙動](#331-基本的な並列実行の挙動)
  - [3.3.2. 独立したブランチ戦略](#332-独立したブランチ戦略)
- [3.4. 潜在的な問題と対策](#34-潜在的な問題と対策)
  - [3.4.1. 同じファイルへの変更（コンフリクト）](#341-同じファイルへの変更コンフリクト)
  - [3.4.2. APIレート制限](#342-apiレート制限)
  - [3.4.3. コスト増加](#343-コスト増加)
- [3.5. concurrencyによる制御](#35-concurrencyによる制御)
  - [3.5.1. 基本設定](#351-基本設定)
  - [3.5.2. ユースケース別設定](#352-ユースケース別設定)
- [3.6. ベストプラクティス](#36-ベストプラクティス)

## 3.1. 概要

GitHub ActionsでClaude Codeを使用する場合、複数のIssue/PRに対して同時にワークフローを実行できる。各実行は独立したコンテナ環境で動作するため、基本的には相互干渉なく並列処理が可能である。ただし、同じファイルを編集する場合のコンフリクトやAPIレート制限など、注意すべき点がある。

## 3.2. GitHub Actionsの並列実行仕様

### 3.2.1. 同時実行ジョブ数の制限

| プラン | 同時実行ジョブ数 |
|--------|-----------------|
| GitHub Free | 20ジョブ |
| GitHub Pro | 40ジョブ |
| GitHub Team | 60ジョブ |
| GitHub Enterprise Cloud | 180ジョブ |

**注意**: 上記は組織/ユーザー全体での同時実行ジョブ数の上限である。

### 3.2.2. 並列実行の仕組み

```
Issue #1 → @claude → ワークフロー実行A → 独立したランナー
Issue #2 → @claude → ワークフロー実行B → 独立したランナー
Issue #3 → @claude → ワークフロー実行C → 独立したランナー
```

**特徴**:
- 各ワークフロー実行は独立したランナー（コンテナ）で動作する。
- 実行間でのファイルシステムやメモリの共有はない。
- 各実行は独立したリポジトリのクローンを取得する。

## 3.3. 複数Issue/PRでの同時実行

### 3.3.1. 基本的な並列実行の挙動

複数のIssue/PRでClaude Codeを同時実行することは、技術的に対応している。

**問題ない点**:
- **並列実行**: GitHub Actionsは複数のワークフローを同時実行可能
- **独立した環境**: 各実行は独立したコンテナで動作
- **ブランチ分離**: 各Issueで別のブランチが作成されるため競合せず

**例**:
```
Issue #1 → ブランチ: claude/issue-1-20251215-0622
Issue #2 → ブランチ: claude/issue-2-20251215-0625
Issue #3 → ブランチ: claude/issue-3-20251215-0628
```

### 3.3.2. 独立したブランチ戦略

claude-code-actionは自動的にブランチを作成する際、Issue番号とタイムスタンプを含めた一意のブランチ名を使用する。

**ブランチ命名規則**:
```
claude/issue-{issue_number}-{YYYYMMDD}-{HHMM}
```

これにより、同時に複数のIssueで作業しても、ブランチ名の衝突は発生しない。

## 3.4. 潜在的な問題と対策

### 3.4.1. 同じファイルへの変更（コンフリクト）

**問題**:
複数のIssueが同じファイルを編集すると、マージ時にコンフリクトが発生する。

**例**:
```
Issue #1: src/config.py の設定Aを変更
Issue #2: src/config.py の設定Bを変更
          ↓
マージ時にコンフリクト発生
```

**対策**:
1. **順次マージ**: 1つずつPRをマージし、他のブランチを最新のmainからリベース
2. **手動コンフリクト解決**: コンフリクトを手動で解決
3. **タスク分割**: 同じファイルを触るタスクは順次実行に変更

> **注意**: 以下のconcurrency設定は一般的な推奨例である。実際のプロジェクト要件（同時実行の必要性、コンフリクト発生頻度等）に応じて調整すること。

**ワークフローでの設定**:
```yaml
# 同じIssueに対する実行を直列化
concurrency:
  group: claude-${{ github.event.issue.number || github.event.pull_request.number }}
  cancel-in-progress: false
```

### 3.4.2. APIレート制限

**GitHub API制限**:
- 認証済みリクエスト: 5,000リクエスト/時間
- GitHub Appを使用している場合: より緩い制限

**Claude API制限**:
- Anthropic API: プランにより異なる。
- AWS Bedrock: リージョンとアカウントのクォータによる。

**対策**:
```yaml
# レート制限に達した場合のリトライ設定
steps:
  - name: Run Claude with retry
    uses: anthropics/claude-code-action@v1
    with:
      anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
    env:
      CLAUDE_RETRY_MAX_ATTEMPTS: 3
      CLAUDE_RETRY_DELAY_MS: 5000
```

### 3.4.3. コスト増加

**問題**:
同時実行が多いとGitHub Actions + Claude APIの料金が増加する。

**コスト要因**:
- GitHub Actions: 実行時間に応じた課金（プライベートリポジトリ）
- Claude API: トークン使用量に応じた課金

**対策**:
1. **実行条件の制限**: 特定のラベルやプレフィックスでトリガーを制限
2. **モデル選択**: 軽量なタスクにはhaiku、重要なタスクにはsonnet/opusを使い分け
3. **実行回数の監視**: 不要な実行を避けるルール設定

```yaml
# 特定のラベルがある場合のみ実行
jobs:
  claude:
    if: contains(github.event.issue.labels.*.name, 'claude-enabled')
```

## 3.5. concurrencyによる制御

### 3.5.1. 基本設定

GitHub Actionsの`concurrency`設定を使用して、同時実行を制御できる。

```yaml
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
```

**パラメータ説明**:
- `group`: 同じグループ名の実行は直列化される
- `cancel-in-progress`: 新しい実行が開始されると、進行中の実行をキャンセル

### 3.5.2. ユースケース別設定

> **注意**: 以下の設定例は一般的なガイドラインである。実際のプロジェクト要件に応じて調整すること。

**Issue単位で直列化（推奨）**:
```yaml
concurrency:
  group: claude-issue-${{ github.event.issue.number }}
  cancel-in-progress: false
```
同じIssueに対する複数の@claudeコメントを順番に処理する。

**PR単位で直列化**:
```yaml
concurrency:
  group: claude-pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true
```
同じPRに対する実行は最新のものだけを実行する。

**リポジトリ全体で直列化**:
```yaml
concurrency:
  group: claude-${{ github.repository }}
  cancel-in-progress: false
```
リポジトリ全体で1つずつ順番に実行（競合回避を最優先）する。

## 3.6. ベストプラクティス

### 3.6.1. 並列実行が適しているケース

- **独立したタスク**: 異なるファイルや機能を扱うIssue
- **緊急性の低いタスク**: バッチ処理、夜間実行
- **レビュー系タスク**: 読み取り専用の分析・レビュー

### 3.6.2. 順次実行が適しているケース

- **同じファイルを編集するタスク**: コンフリクトを避けるため
- **依存関係があるタスク**: 前のタスクの結果に依存する場合
- **APIレート制限に近い状況**: リクエストを分散させるため

### 3.6.3. 推奨設定

```yaml
name: Claude Code Action

on:
  issue_comment:
    types: [created]

concurrency:
  # Issue単位で直列化
  group: claude-${{ github.event.issue.number }}
  # 進行中の実行はキャンセルしない
  cancel-in-progress: false

jobs:
  claude:
    if: contains(github.event.comment.body, '@claude')
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
```

### 3.6.4. 運用上の推奨事項

1. **関連性の低いタスクは同時実行OK**
2. **同じファイルを触るタスクは順次実行**
3. **定期的にブランチをmainにマージして、ベースブランチを最新に保つ**
4. **APIコストを監視し、不要な実行を避ける**
5. **長時間実行タスクにはタイムアウトを設定**

***

[目次](./01_はじめに.md#目次)
