# 5. 参照するコンテキスト範囲<!-- omit in toc -->

GitHub Actions版Claude Codeが参照するコンテキスト範囲について記載する。

## 目次<!-- omit in toc -->

- [5.1. 概要](#51-概要)
- [5.2. コンテキストの種類](#52-コンテキストの種類)
  - [5.2.1. リポジトリコンテキスト](#521-リポジトリコンテキスト)
  - [5.2.2. イベントコンテキスト](#522-イベントコンテキスト)
  - [5.2.3. 会話コンテキスト](#523-会話コンテキスト)
- [5.3. EC2版との比較](#53-ec2版との比較)
  - [5.3.1. コンテキストアクセス範囲の違い](#531-コンテキストアクセス範囲の違い)
  - [5.3.2. コンテキスト管理の違い](#532-コンテキスト管理の違い)
- [5.4. コンテキストウィンドウの制限](#54-コンテキストウィンドウの制限)
  - [5.4.1. モデル別のコンテキストウィンドウ](#541-モデル別のコンテキストウィンドウ)
  - [5.4.2. 実効的な制限](#542-実効的な制限)
- [5.5. コンテキスト最適化](#55-コンテキスト最適化)
  - [5.5.1. プロンプト設計の工夫](#551-プロンプト設計の工夫)
  - [5.5.2. ファイル参照の効率化](#552-ファイル参照の効率化)
- [5.6. 注意点と制限事項](#56-注意点と制限事項)

## 5.1. 概要

GitHub Actions版Claude Codeは、トリガーとなったイベント（Issue、PR、コメント等）に関連する情報とリポジトリ全体のファイルにアクセスできる。ただし、Claude AIのコンテキストウィンドウには上限があるため、すべての情報を一度に処理できるわけではない。

## 5.2. コンテキストの種類

### 5.2.1. リポジトリコンテキスト

GitHub Actions版Claude Codeがアクセスできるリポジトリ情報：

**アクセス可能**:
- リポジトリ内の全ファイル（チェックアウト後）
- ディレクトリ構造
- .gitignoreされていないファイル
- CLAUDE.md（プロジェクト設定ファイル）
- .claude/agents/（サブエージェント定義）
- .claude/settings.json（ローカル設定）

**アクセス不可**:
- .gitignoreされたファイル（チェックアウト時に除外）
- プライベートサブモジュール（追加設定なしの場合）
- LFS管理の大容量ファイル（追加設定なしの場合）
- ワークフロー実行前に削除されたファイル

**設定ファイルの優先順位**:
1. リポジトリ内の .claude/settings.json
2. リポジトリ内の CLAUDE.md
3. ワークフローの custom_instructions パラメータ

### 5.2.2. イベントコンテキスト

トリガーイベントに応じて異なる情報にアクセス可能：

**issue_comment イベント**:
- Issue番号、タイトル、本文
- Issue作成者
- Issueのラベル
- トリガーとなったコメント内容
- コメント作成者
- 過去のIssueコメント履歴（API経由）

**pull_request イベント**:
- PR番号、タイトル、本文
- PR作成者
- ベースブランチ、ヘッドブランチ
- 変更されたファイル一覧
- 差分（diff）内容
- PRのレビューコメント
- ステータスチェック結果

**issues イベント**:
- Issue番号、タイトル、本文
- Issue作成者
- Issueのラベル
- アサインされたユーザー

### 5.2.3. 会話コンテキスト

claude-code-actionは単発実行のため、EC2版のような継続的な会話コンテキストは基本的に維持されない。

**実行ごとのコンテキスト**:
- 各実行は独立（前回の実行内容を自動的には引き継がない）
- 同じIssue内の過去コメントはAPI経由で参照可能
- 明示的にコメントで前回の結果を参照する必要あり

**コンテキスト継続の工夫**:
```markdown
# Issueコメントでの継続指示例
@claude 前回の修正に加えて、以下の変更もお願いします：
- 前回作成したブランチ: claude/issue-123-20251215
- 追加で必要な変更点: ...
```

## 5.3. EC2版との比較

コンテキストアクセス範囲の詳細な比較については、[04_EC2上ClaudeAgentSDKとの違い.md](./04_EC2上ClaudeAgentSDKとの違い.md)も参照のこと。本章ではコンテキスト管理に焦点を当てた比較を記載する。

### 5.3.1. コンテキストアクセス範囲の違い

**凡例**: ✅=対応 / ❌=非対応 / △=条件付き対応

| コンテキスト | GitHub Actions版 | EC2版 |
|-------------|-----------------|------|
| リポジトリファイル | ✅ チェックアウト後 | ✅ 常時アクセス可能 |
| Issue/PR情報 | ✅ 自動取得 | ❌ 手動取得が必要 |
| 過去の会話 | △ API経由で取得 | ✅ セッション内で維持 |
| ローカルファイル | ❌ リポジトリのみ | ✅ EC2上の全ファイル |
| データベース | ❌ | ✅ 接続可能 |
| 外部API | △ 制限あり | ✅ 自由 |
| 環境変数 | GitHub Secrets | EC2環境変数 |

### 5.3.2. コンテキスト管理の違い

**GitHub Actions版**:
```
+-------------------------------------+
|         実行1（Issue #1）            |
|  +-----------------------------+    |
|  | リポジトリ + Issue情報       |    |
|  | → 処理 → 結果コメント        |    |
|  +-----------------------------+    |
|         （実行終了後に破棄）          |
+-------------------------------------+
          ↓ コンテキスト引き継ぎなし
+-------------------------------------+
|         実行2（Issue #1）            |
|  +-----------------------------+    |
|  | リポジトリ + Issue情報       |    |
|  | （前回の実行結果はコメント    |    |
|  |   として参照可能）           |    |
|  +-----------------------------+    |
+-------------------------------------+
```

**EC2版**:
```
+-------------------------------------+
|           セッション                 |
|  +-----------------------------+    |
|  | 対話1 → 対話2 → 対話3        |    |
|  |     ↓       ↓       ↓       |    |
|  |  コンテキストが累積・維持     |    |
|  +-----------------------------+    |
|  +-----------------------------+    |
|  | ローカルファイル、DB等も      |    |
|  | 継続的にアクセス可能          |    |
|  +-----------------------------+    |
+-------------------------------------+
```

## 5.4. コンテキストウィンドウの制限

### 5.4.1. モデル別のコンテキストウィンドウ

> **注意**: 以下の値は2025年12月時点のものである。モデルの仕様は随時更新されるため、最新情報は公式ドキュメントを参照すること。

| モデル | コンテキストウィンドウ | 出力上限 |
|--------|----------------------|---------|
| Claude 3 Opus | 200K tokens | 4K tokens |
| Claude 3.5 Sonnet | 200K tokens | 8K tokens |
| Claude 3 Haiku | 200K tokens | 4K tokens |

**注意**: 1 token ≒ 約4文字（英語）、約1-2文字（日本語）

### 5.4.2. 実効的な制限

GitHub Actions版では、コンテキストウィンドウを以下の要素で消費：

```
+-------------------------------------+
| コンテキストウィンドウ (200K tokens)  |
+-------------------------------------|
| システムプロンプト         (~5K)     |
| CLAUDE.md設定             (~2K)     |
| Issue/PR情報              (~1-5K)   |
| 過去のコメント履歴        (可変)      |
| 読み込んだファイル        (可変)      |
| ツール呼び出し履歴        (可変)      |
+-------------------------------------|
| 出力用予約領域            (~8K)      |
+-------------------------------------+
```

**大規模リポジトリでの注意**:
- 全ファイルを一度に読み込むことは不可能
- 必要なファイルを選択的に読み込む
- grep/globで検索してから読み込む

## 5.5. コンテキスト最適化

### 5.5.1. プロンプト設計の工夫

**効率的なプロンプト例**:
```markdown
@claude 以下のタスクを実行してください：

## 対象ファイル
- src/api/users.py （ユーザー認証ロジック）
- src/models/user.py （ユーザーモデル）

## タスク
1. src/api/users.py の authenticate 関数にレート制限を追加
2. 既存のテストを確認し、必要に応じて更新

## 参考
- 既存のレート制限実装は src/utils/rate_limit.py を参照
```

**避けるべきプロンプト**:
```markdown
# 悪い例：曖昧で広範囲
@claude ユーザー認証を改善してください
```

### 5.5.2. ファイル参照の効率化

**CLAUDE.mdでの設定**:
```markdown
# プロジェクト構造
このプロジェクトは以下の構造です：
- src/: ソースコード
- tests/: テストコード
- docs/: ドキュメント

# 重要なファイル
- src/config.py: 設定ファイル
- src/utils/: ユーティリティ関数

# コード規約
- PEP 8準拠
- 型ヒント必須
```

## 5.6. 注意点と制限事項

### 5.6.1. コンテキスト冗長化の問題

複数回の実行で同じファイルを繰り返し読み込むと、コンテキストが冗長化する：

**問題のパターン**:
```
実行1: ファイルA読み込み → 処理
実行2: ファイルA再読み込み → ファイルB読み込み → 処理
実行3: ファイルA再読み込み → ファイルB再読み込み → ファイルC読み込み
```

**対策**:
- プロンプトで必要なファイルを明示的に指定
- 不要なファイル読み込みを避ける指示
- タスクを小さく分割

### 5.6.2. セキュリティ上の制限

**アクセスできない情報**:
- 他のリポジトリの情報
- GitHub Secretsの値（環境変数としてのみ利用可能）
- プライベートな組織情報
- 他のユーザーの認証情報

**allowedToolsによる制限**:
```yaml
with:
  allowed_tools: "Read,Grep,Glob,Write"
  # Bash, WebFetchなどを制限可能
```

### 5.6.3. 大規模リポジトリでの制限

**課題**:
- 数万ファイルのリポジトリでは全体把握が困難
- モノレポでの特定パッケージへのフォーカスが必要

**対策**:
```markdown
# CLAUDE.md での対策例
## 作業範囲
このリポジトリはモノレポです。主に以下のパッケージで作業してください：
- packages/frontend/: フロントエンドアプリ
- packages/api/: バックエンドAPI

## 除外対象
以下は自動生成されるため編集不要：
- **/node_modules/
- **/dist/
- **/.next/
```

***

[目次](./01_はじめに.md#目次)
